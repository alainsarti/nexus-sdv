# Registration Server
This directory contains the registration server, which signs the operational certificates.

## Startup
To start the server run the project using cargo. It will listen for incoming requests on `https://localhost:8081`.
```bash
$ cargo run
```

## Sending a request
First you have to generate a client certificate using the factory CA. You need to pass the client certificate and client key for authentication and send the Certificate Signing Request as the data. 
```bash
$ curl -v --insecure  --cert client.cert.pem --key client.key.pem https://localhost:8081/registration --data-binary @client.csr.pem
```

The server will return a JSON object including the issued certificate, the keycloak URL and the NATS URL. These URLs are retrieved at runtime using environment variables set by helm.
```json
{
    "certificate": "-----BEGIN CERTIFICATE-----\nMIICYDCCA...xwIhAPpLfFSEsB\n-----END CERTIFICATE-----",
    "keycloak_url": "URL to the Keycloak server (for example: https://localhost:8443)",
    "nats_url": "URL to the NATS server (for example: nats://localhost:4443)"
}
```

## Health
There is a simple /health endpoint that can be accessed without a client certificate or any authentication to test the server status.

## Certificates
The `certificates` directory contains all certificates and keys needed to run this server. The `server` certificates are generated by the `server-ca` and used to establish a TLS connection with the client. In the `signing` directory is the Certificate Authority located which signs the Certificate Signing Requests. The `trusted_factory_ca.pem` certificate is the CA certificate of the `factory-ca`.
