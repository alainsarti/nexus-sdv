services:
  bigtable-emulator:
    image: gcr.io/google.com/cloudsdktool/cloud-sdk:emulators
    ports:
      - "8086:8086"
    command: >
      sh -c "gcloud beta emulators bigtable start --host-port=0.0.0.0:8086 --project=test-project"
    environment:
      - BIGTABLE_EMULATOR_HOST=localhost:8086
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086"]
      interval: 30s
      timeout: 10s
      retries: 5

  data-api-server:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - BIGTABLE_EMULATOR_HOST=bigtable-emulator:8086
      - GRPC_ADDR=0.0.0.0:8080
      - GCP_PROJECT=test-project
      - BT_INSTANCE=test-instance
      - BT_TABLE=telemetry
      - LOG_LEVEL=debug
      - TEST_ENV=true
